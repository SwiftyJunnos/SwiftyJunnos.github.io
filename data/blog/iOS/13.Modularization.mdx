---
title: 📱 iOS - 모듈화와 Clean Architecture
date: 2023-06-20
tags:
  - Swift
  - iOS
  - MusicSpot
draft: false
summary: 모듈화 된 구조 Clean Architecture 시점에서 개선하기
---

# Modular Architecture

MusicSpot 프로젝트는 모듈러 아키텍처를 채택해서 사용했습니다.

하지만 사실 "모듈러 아키텍처"의 어떤 장점을 살리겠다 는 점 보다는

분리된 각 레이어를 강하게 분리시켜서 `import`하지 않으면 사용할 수 없도록

아주 강한 제약을 두고 각 레이어에 대해 학습하겠다!

측면이 강했습니다.

그렇다면 그 목적에 맞게 각 레이어의 독립이 아주 잘 이루어졌어야겠죠?

과연 그랬을까요?

## 문제가 많아 보이는 현재 구조

지난 프로젝트를 돌아보며, 과연 모듈러 아키텍처의 채택 목적에 맞게

아키텍처를 "잘" 사용하고 있을까? 를 돌아보기로 했습니다.

그래서 Dependency 그래프를 한 번 그려봤습니다.

(저희 앱은 Tuist를 사용하고 있지 않기 때문에, 한땀한땀 그려줘야 했습니다.)

![](https://i.imgur.com/IflEaig.jpg)

네.. 많이 어지럽네요 ㅎ..

이를 조금 _(많이)_ 단순화 시켜보면 아래와 같아집니다.

![](https://i.imgur.com/7KzZ84W.png)

여기서 제게 생긴 의문점은 크게 세가지입니다.

1. Feature 패키지 중 **MSCoreKit**의 기능을 **직접 가져다 쓰는 부분**이 있다. 직접적으로 사용하는 대신 MSData에서 사용하는 것이 바람직하지 않은가?
2. Feature 패키지가 **MSData와 MSDomain 레이어를 모두** 의존하고 있다. MSDomain 레이어는 지금 형태가 최선인가?
3. MSFoundation 패키지, 특히 Logger의 경우 모든 패키지가 **구분 없이** 의존성을 갖고 있다. 괜찮은건가?

하나하나 고민해봅시다.

## CoreKit의 의존성은 어디를 향해야 하는가

가장 큰 고민을 가지고 있는 부분입니다.

CoreKit의 로직들이 Feature 모듈들에 열려있어도 되는가? 에 대한 문제입니다만

Clean Architecture의 어떤 레이어와 연관성이 높은 지 부터 살펴보겠습니다.

저희가 내렸던 CoreKit에 대한 정의는 다음과 같습니다.

> 앱의 핵심적인 로직들이 포함된 모듈

네트워킹, 캐싱, 로컬 파일 저장 등 비교적 리소스를 많이 잡아먹는 로직들이 포함됩니다.

또, 한 가지 공통점이 하나 더 있는데, 지금까지는 어떤 형태로든 **데이터**를 휙득하거나 가공하는 로직들이 포함되어 있다는 것입니다.

그렇기 때문에 Presentation 레이어보다는 **Data 레이어**와의 연관성이 훨씬 높습니다.

여기까지가 Data 레이어가 CoreKit 모듈을 의존해야하는 이유였고, 이제부터는 Feature 모듈들에서의 이야기입니다.

Presentation 레이어에서 CoreKit의 로직을 왜 필요로 하고 있을까요?

가장 대표적인 예시입니다.

```swift
self.imageView.ms.setImage(url: someURL)
```

ImageFetcher 모듈의 `UIImageView`에 대한 extension을 활용한 방식입니다.

이 문제는 다행히 `ms`로 wrapping한 부분을 UI 모듈쪽으로 분리하는 것으로 쉽게 해결할 수 있었습니다.

근본적은 물음에 대한 답은 어떻게 내리면 될까요?

> Presentation 레이어에 해당하는 Feature 모듈들은 CoreKit에 대한 의존을 가져도 되는가?

CoreKit을 모듈화하고, Data 레이어에 의존성을 부여하는 것에 대한 장점을 정리해보면 좋을 것 같습니다.

1. 최외곽인 Presentation 레이어에서 로직에 대한 관심을 끊어낼 수 있습니다. 이후 로직이 변경되더라도 추상화한 Protocol이 바뀌지 않는 한 Presentation 레이어의 변경점은 없습니다.
2. Presentation 레이어에 Repository를 주입시켜주는 것 만으로도 테스트가 가능하다.

제가 생각하는 가장 큰 이점은 이 두가지입니다.

쉽게 말하면 **1. 약한 결합**과 **2. 테스트 용이성**입니다.

그렇다면 이 장점을 반대로 말하면 Feature 모듈이 CoreKit에 의존할 경우 발생하는 문제점이 되겠죠?

1. CoreKit의 로직이 변경될 경우, 이 로직을 사용하는 모든 Feature 부분의 코드에 변경이 가해져야 한다.
2. Presentation 레이어의 테스트를 위해 CoreKit을 필수적으로 import 해야한다. 즉, CoreKit의 변화가 CoreKit 자체의 테스트뿐만 아니라 ViewModel의 테스트에도 영향을 준다.

결국 단점은 CoreKit의 변화가 파편화 된 코드들에 영향을 주고, 변화를 강제한다는 것 입니다.

## 결국은 UseCase..?

두 번째 주제, Feature 모듈들이 Data 레이어와 Domain 레이어 모두를 의존하고 있는데, 괜찮은건가? 입니다.

이 주제에 대해 이야기하기 전에, 저희 앱은 UseCase를 사용하고 있지 않습니다.

그 필요성을 느끼지 못했기 때문인데요..

따라서 Domain 레이어에는 사실상 엔티티만 포함되어 있습니다.

때문에 Repository의 로직을 사용하기 위해 Data 레이어를, 엔티티 모델들을 사용하기 위해서 Domain 레이어를 모두 의존하고 있는 것이죠.

그렇다고 단순하게 Presentation 레이어가 Domain 레이어만을 의존하도록 만들기 위해 UseCase를 도입하는 것은 도입의 이유로서 타당하지 않다고 생각합니다.

그렇다면 Domain 레이어 자체를 손봐야겠죠..?

![](https://i.imgur.com/0rfLHfN.png)

자, 이쯤에서 다시 한 번 현재 구조를 살펴봅시다.

저희 구조 상 한가지 특이한 점이 있는데요, 바로 **Domain 레이어가 다른 어떤 모듈도 의존하지 않고 있다**는 점입니다.

> WIP...