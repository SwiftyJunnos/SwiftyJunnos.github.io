---
title: ğŸ Swift - URLProtocol
date: 2023-11-24
tags:
  - Swift
  - MusicSpot
draft: false
summary: ë„¤íŠ¸ì›Œí‚¹ì´ í…ŒìŠ¤íŠ¸ê°€ ëœë‹¤ê³ !?
---

<TOCInline toc={props.toc} indentDepth={2} />

# ë°°ê²½
ë„¤íŠ¸ì›Œí‚¹ì„ í…ŒìŠ¤íŠ¸í•˜ê¸´ í•´ì•¼í•  ê²ƒ ê°™ì€ë°.. ì–´ë–»ê²Œ í•˜ì§€...?

ì•„..! í•™ìŠµ ìŠ¤í”„ë¦°íŠ¸ ë•Œ `URLProtocol`ì´ë€ê±¸ ì–¸ê¸‰í•˜ì…¨ë˜ ê²ƒ ê°™ì€ë°..!?

# ê³¼ì •

## URLRequest to Response

![](https://i.imgur.com/h8JKcQI.png)

ì•±ì€ ì‹¤ì œë¡œ ë„¤íŠ¸ì›Œí¬ í†µì‹ ì„ í•˜ê¸° ìœ„í•´ ìœ„ ì‚¬ì§„ê³¼ ê°™ì€ ê³¼ì •ì„ ê±°ì¹©ë‹ˆë‹¤.

1. URLRequestë¥¼ ìƒì„±í•˜ê³ 
2. URLRequestë¥¼ ì´ìš©í•´ URLSession Taskë¥¼ ë§Œë“­ë‹ˆë‹¤.
3. *ì„œë²„ì™€ ë°ì´í„°ë¥¼ ì£¼ê³  ë°›ìœ¼ë©´*
4. ë°›ì€ ë°ì´í„°ë¥¼ íŒŒì‹±í•´ì„œ ì‚¬ìš©í•©ë‹ˆë‹¤.

ì €í¬ëŠ” ì´ ì¤‘ì—ì„œ 3ë²ˆ ê³¼ì •ì„ Mock ì„œë²„ë¡œ ë°”ê¾¸ê³  ì‹¶ì€ê±°ì£ ?

![](https://i.imgur.com/hJZsu2B.png)

URLSessionì„ ë§Œë“¤ ë•Œ í•„ìš”í•œ `URLSessionConfiguration`ì€ `URLProtocol`ë“¤ì„ ì‚¬ìš©í•œë‹¤ê³  í•˜ëŠ”ë°ìš”,

```swift
let configuration: URLSessionConfiguration = .ephemeral
configuration.protocolClasses?.insert(MockURLProtocol.self, at: .zero)
```

ì—¬ê¸°ì— ì €í¬ê°€ ì›í•˜ëŠ” ì»¤ìŠ¤í…€ Protocolì„ ë„£ëŠ”ë‹¤ë©´?

ì €í¬ê°€ ì›í•˜ëŠ” ë°©ì‹ëŒ€ë¡œ `URLSession`ì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ê²ë‹ˆë‹¤!

ì´ URLProtocolì´ ë„¤íŠ¸ì›Œí¬ ì»¤ë„¥ì…˜ì„ ì—´ê³ , Requestë¥¼ ìƒì„±í•˜ê³ , Responseë¥¼ ë°›ì•„ ì²˜ë¦¬í•˜ëŠ” ê³¼ì •ê¹Œì§€ ëª¨ë“  ê±¸ ì›í•˜ëŠ” ë°©ì‹ëŒ€ë¡œ ë§Œë“¤ì–´ì¤„ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— Mockingì— ìœ ìš©í•œ ê²ƒì´ì£ .

ê·¼ë° ë§ë¡œë§Œ ë“¤ì–´ë³´ë©´ í…ŒìŠ¤íŒ…ì´ ì•„ë‹ˆë¼ ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©í•  ë•Œë„ ê½¤ ìœ ìš©í•  ìˆ˜ ìˆê² ë‹¤ëŠ” ìƒê°ì´ ë“­ë‹ˆë‹¤.

## URLProtocol

ì–´ë–¤ ë†ˆì¸ì§€ëŠ” ì•Œì•˜ì§€ë§Œ ê·¸ë˜ë„ ì •ì˜ëŠ” í•œ ë²ˆ ë´ì¤˜ì•¼ê² ì£ ?
ê³µì‹ë¬¸ì„œ ê³ ê³ 

![](https://i.imgur.com/cmbozoB.png)

> í”„ë¡œí† ì½œì— ë”°ë¼ URL ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ê³¼ì •ì„ í•¸ë“¤ë§í•˜ëŠ” ì¶”ìƒ í´ë˜ìŠ¤

ì´ë¦„ì€ Protocolì¸ë° ì •ì‘ í´ë˜ìŠ¤ë„¤ìš”..ã…

![](https://i.imgur.com/GYs6yyJ.png)

ì‚¬ìš©ë²•ì€ `URLProtocol`ì„ ìƒì†ë°›ê³ , `override` ë©”ì„œë“œë¥¼ ë„¤ ê°€ì§€ ì‘ì„±í•´ì£¼ë©´ ë©ë‹ˆë‹¤.

### canInit
ì£¼ì–´ì§„ `URLRequest`ì— `URLProtocol`ì„ ì ìš©í•  ì§€ ì—¬ë¶€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.

`request` íŒŒë¼ë¯¸í„°ì— ì–´ë–¤ ì¡°ê±´ë¬¸ì„ ê±¸ì–´ì„œ `true`ë‚˜ `false`ë¥¼ ë°˜í™˜í•´ì£¼ë©´ ë˜ëŠ”ë°...

ëŒ€ë¶€ë¶„ì˜ ê²½ìš°ì—ëŠ” ê·¸ëƒ¥ `true`ë¥¼ ë°˜í™˜í•´ì£¼ë©´ ë©ë‹ˆë‹¤.

### canonicalRequest
ì—¬ê¸°ì„œëŠ” ì‚¬ìš©í•  `URLRequest`ë¥¼ ë°”ê¿”ì¹˜ê¸° í•  ìˆ˜ ìˆëŠ”ë°ìš”..

ë§ˆì°¬ê°€ì§€ë¡œ ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ê·¸ëƒ¥ `request`ë¥¼ ê·¸ëŒ€ë¡œ ë°˜í™˜í•´ì¤ë‹ˆë‹¤.

### startLoading
ì‹¤ì œë¡œ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ë©”ì„œë“œì…ë‹ˆë‹¤.

```swift
static var requestHandler: ((URLRequest) throws -> (HTTPURLResponse, Data))?
```

ì´ëŸ° `requestHandler`ë¥¼ í•˜ë‚˜ ë§Œë“¤ì–´ì„œ

```swift
guard let handler = MockURLProtocol.requestHandler else {
	XCTFail("Received unexpected request with no handler set")
	return
}

do {
	let (response, data) = try handler(request)
	client?.urlProtocol(self, didReceive: response, cacheStoragePolicy: .notAllowed)
	client?.urlProtocol(self, didLoad: data)
	client?.urlProtocolDidFinishLoading(self)
} catch {
	client?.urlProtocol(self, didFailWithError: error)
}
```

ì´ëŸ°ì‹ìœ¼ë¡œ ì‚¬ìš©í•´ì¤ë‹ˆë‹¤.

### stopLoading

ì´ ë©”ì„œë“œëŠ” Taskê°€ ì·¨ì†Œë˜ì–´ì•¼ í•  ë•Œì˜ í–‰ë™ê°•ë ¹ë“¤ì„ ì ëŠ” ê³³ì¸ë°ìš”,

MockURLProtocolì˜ ê²½ìš°ì—ëŠ” ì·¨ì†Œë¥¼ ëª©ì ìœ¼ë¡œ í•˜ì§€ëŠ” ì•Šê¸° ë•Œë¬¸ì— ë¹ˆ ì¹¸ìœ¼ë¡œ ë¹„ì›Œë‘ì—ˆìŠµë‹ˆë‹¤.

## XCTestCaseì—ì„œ ì‚¬ìš©í•´ë³´ê¸°

ì´ë ‡ê²Œ MockURLProtocolì„ ìƒì„±í–ˆë‹¤ë©´ ì‚¬ìš©í•  ì¤€ë¹„ê°€ ëë‚œê²ë‹ˆë‹¤!

```swift
override func setUp() {
	URLProtocol.registerClass(MockURLProtocol.self)
	let configuration: URLSessionConfiguration = .ephemeral
	configuration.protocolClasses?.insert(MockURLProtocol.self, at: .zero)
	let session = URLSession(configuration: configuration)
	self.networking = MSNetworking(session: session)
}
```

`setUp`ì—ì„œ ì•ì„œ ë´¤ë˜ëŒ€ë¡œ `URLSessionConfiguration`ì— `MockURLProtocol`ì„ ë„£ì–´ì¤ë‹ˆë‹¤.

ê·¸ë¦¬ê³  í•´ë‹¹ Configurationìœ¼ë¡œ `URLSession`ì„ ë§Œë“¤ì–´ì„œ ì‚¬ìš©í•´ì£¼ë©´ ë©ë‹ˆë‹¤!

ê° Test Caseë§ˆë‹¤ ë‹¤ë¥¸ Responseë¥¼ í…ŒìŠ¤íŠ¸í•˜ê² ì£ ?

```swift
MockURLProtocol.requestHandler = { _ **in**
	let response = HTTPURLResponse(url: URL(string: "https://api.codesquad.kr")!,
								   statusCode: 200,
								   httpVersion: nil,
								   headerFields: ["Content-Type": "application/json"])!
	return (response, data)
}
```

`MockURLProtocol`ì— `static`ìœ¼ë¡œ ì •ì˜í•´ë‘ì—ˆë˜ `requestHandler`ë¥¼ ì—¬ê¸°ì„œ ì •ì˜í•´ì£¼ë©´ ë©ë‹ˆë‹¤.

ì´ë ‡ê²Œ ì›í•˜ëŠ” responseë¥¼ ë§Œë“¤ì–´ì„œ ë°˜í™˜ì„ í•´ì£¼ë©´, `MockURLProtocol`ì˜ `startLoading` ë©”ì„œë“œì—ì„œ í•´ë‹¹ í•¸ë“¤ëŸ¬ë¡œ ì£¼ì–´ì§„ ì‘ë‹µì„ ê³ ì •ì ìœ¼ë¡œ ë‚´ë†“ê²Œ ë˜ëŠ” ê²ƒì´ì£ .

# ê²°ê³¼

`Repository`ë‹¨ì—ì„œ Mockì„ ë§Œë“¤ì–´ì„œ ë°˜í™˜í•˜ëŠ” ë°©ë²•ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì¤„ ì•Œì•˜ëŠ”ë°,

ì´ë ‡ê²Œ ë„¤íŠ¸ì›Œí‚¹ ìì²´ë¥¼ Mockingí•  ìˆ˜ ìˆë‹¤ëŠ” ì ì´ ê½¤ ì‹ ê¸°í–ˆìŠµë‹ˆë‹¤.

Responseì˜ statusCodeë‚˜ íŠ¹ë³„í•œ ì‘ë‹µì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì‘ì„±í•  ë•Œ ì•„ì£¼ ìœ ìš©í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆì„ ê²ƒ ê°™ë„¤ìš”.

### ì°¸ê³  ë¬¸ì„œ
[WWDC2018 - Testing Tips & Tricks](https://developer.apple.com/videos/play/wwdc2018/417/)