---
title: 'ğŸ Swift - RxSwift Traits'
date: '2023-02-22'
tags: ['Swift']
draft: false
summary: 'Coordinator íŒ¨í„´ì˜ Rxí™”'
---

# Traits

`Traits`ëŠ” `Observable`ì˜ í•œ ì¢…ë¥˜ë¼ê³  ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

TraitsëŠ” UI ì˜ì—­ì—ì„œ ë³µì¡í•˜ê³  ë‹¤ì–‘í•œ ê¸°ëŠ¥ì´ ìˆëŠ” `Observable` ëŒ€ì‹  ì‚¬ìš©ë˜ê¸° ìœ„í•´ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ RxCocoaì™€ ì•„ì£¼ ë°€ì ‘í•œ ê´€ë ¨ì´ ìˆì§€ë§Œ, ëª‡ëª‡ ê¸°ëŠ¥ë“¤ì€ RxSwift ì „ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ë  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— RxSwiftì™€ RxCocoaì— ë‚˜ëˆ„ì–´ êµ¬í˜„ë˜ì—ˆë‹¤ê³  í•©ë‹ˆë‹¤.

## ë“±ì¥ ì´ìœ 

Traitsë¥¼ ì™œ ì‚¬ìš©í•´ì•¼í•˜ëŠ”ì§€ë¶€í„° ì•Œì•„ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

TraitsëŠ” `Observable` ì‹œí€€ìŠ¤ê°€ ì•ˆì „í•˜ê²Œ í†µì‹ ë  ìˆ˜ ìˆë„ë¡ ë•ìŠµë‹ˆë‹¤.

ëª¨ë“  ë°©ë©´ì—ì„œ ì‚¬ìš©ë  ìˆ˜ ìˆëŠ” `Observable`ì„ ëŒ€ì‹ í•˜ì—¬ UI ì²˜ë¦¬ì— íŠ¹í™”ëœ ê¸°ëŠ¥ê³¼ ë¬¸ë²•ì„ ì œê³µí•©ë‹ˆë‹¤.

ë”°ë¼ì„œ TraitsëŠ” `Observable`ì´ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì˜ ì¼ë¶€ë¥¼ ë–¼ì–´ë‚¸ ê²ƒê³¼ ë‹¤ë¦„ì—†ê¸° ë•Œë¬¸ì— ì‚¬ìš©í• ì§€ ë§ì§€ì˜ ì—¬ë¶€ëŠ” ì‚¬ìš©ìì—ê²Œ ë‹¬ë ¤ìˆë‹¤ê³  í•©ë‹ˆë‹¤!

## ê¸°ë³¸ ê°œë…

TraitsëŠ” ë‹¨ìˆœíˆ í•˜ë‚˜ì˜ `read-only`í•œ `Observable`ì„ ê°ì‹¸ê³  ìˆëŠ” `struct`ì…ë‹ˆë‹¤.

```swift
struct Single<Element> {
	let source: Observable<Element>
}

struct Driver<Element> {
	let source: Observable<Element>
}
```

Traitsë¥¼ `Observable`ë¡œ ëŒë ¤ë†“ê³  ì‹¶ì„ ë•ŒëŠ” `.asObservable()`ë¡œ ê°„ë‹¨í•˜ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

# RxSwift Traits

## Single

Singleì€ ë¬´ì¡°ê±´ í•˜ë‚˜ì˜ ê°’ ë˜ëŠ” ì—ëŸ¬ë¥¼ ë°©ì¶œí•©ë‹ˆë‹¤.

ì§€ì†ì ì¸ ê°’ì´ ì•„ë‹ˆë¼ ë”± í•œ ë²ˆì˜ ê²°ê³¼ê°’ì´ í•„ìš”í•  ë–„ ì‚¬ìš©ë©ë‹ˆë‹¤.

í•œ ë²ˆì˜ ê°’ë§Œì„ ë°©ì¶œí•˜ê¸° ë–„ë¬¸ì— `.completed`ê°€ ì—†ìŠµë‹ˆë‹¤.

ì‚¬ìš©ë˜ê¸° ê°€ì¥ ì¢‹ì€ ê³³ì€ HTTP í†µì‹ ì„ í•  ë•Œì´ë©°, requestì— í•˜ë‚˜ì˜ ì‘ë‹µë§Œì´ ëŒì•„ì˜¬ ë•Œ ì‚¬ìš©í•˜ë©´ ìœ ìš©í•©ë‹ˆë‹¤.

```swift
func getRepo(_ repo: String) -> Single<[String: Any]> {
	return Single<[String: Any]>.create { single in
		let task = URLSession.dataTask(with: URL(string: "https://api.github.com/\(repo)")! { data, _, error in
			if let error {
				single(.failure(error))
				return
			}

			guard let data,
				let json = try? JSONSerialization.jsonObject(with: data, option: .mutableLeaves),
				let result = json as? [String: Any] else {
					single(.failure(DataError.cantParseJSON))
					return	  
			}

			single(.success(result))
		}
		task.resume()

		return Disposables.create { task.cancel() }
	}
}
```

```swift
getRepo("ReactiveX/RxSwift")
	.subscribe(onSuccess: { json in
			print("JSON: ", json)
		},
		onError: { error in
			print("Error: ", error)
		})
	.disposed(by: self.disposeBag)
```

## Completable

Completableì€ `.completed`ë‚˜ `.error`ë§Œì„ ë°©ì¶œí•©ë‹ˆë‹¤.

í•œë§ˆë””ë¡œ ê°’(`element`)ì„ ë°©ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ì‘ì—…ì˜ ë‚´ìš©ì€ ì¤‘ìš”í•˜ì§€ ì•Šê³ , ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ë§Œ ì¤‘ìš”í•œ ê²½ìš°ì— ì‚¬ìš©ë©ë‹ˆë‹¤.

```swift
func cacheLocally() -> Completable {
	return Completable.create { completable in
		guard success else {
			completable(.error(CacheError.failedCaching))
			return Disposables.create { }
		}

		completable(.completed)
		return Disposables.create { }
	}
}
```

```swift
cacheLocally()
	.subscribe(onCompleted: {
		print("Completed with no error.")
	},
	onError: { error in
		print("Completed with an error: \(error.localizedDescription)")
	})
	.disposed(by: self.disposebag)
```

## Maybe

MaybeëŠ” Singleê³¼ Completableì˜ ì¤‘ê°„ì— ìˆëŠ” Traitì…ë‹ˆë‹¤.

í•˜ë‚˜ì˜ ê°’ì„ ë°©ì¶œí•˜ê±°ë‚˜ ë°©ì¶œ ì—†ì´ `.complete`ë˜ê±°ë‚˜ `.error`ë¥¼ ë°©ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```swift
func generateString() -> Maybe<String> {
	return Maybe<String>.create { maybe in
		maybe(.success("RxSwift"))
		// or
		maybe(.completed)
		// or
		maybe(.error(error))

		return Disposables.create { }
	}
}
```

```swift
generateString()
	.subscribe(onSuccess: { element in
		print("Completed with element \(element)")
	},
	.onError { error in
		print("Completed with an error \(error.localizedDescription)")
	},
	onCompleted: {
		print("Completed with no element")
	})
	.disposed(by: self.disposeBag)
```

# RxCocoa Traits

## Driver

ê°€ì¥ ë§ì´ ì‚¬ìš©ë˜ëŠ” Traitì…ë‹ˆë‹¤.

UI ë ˆì´ì–´ë§Œì„ ìœ„í•´ íŠ¹ë³„í•˜ê²Œ ê°œë°œëœ ê¸°ëŠ¥ì…ë‹ˆë‹¤.

íŠ¹ì§•ì„ ì •ë¦¬í•´ë³´ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

- ì—ëŸ¬ê°€ ë°©ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
- `observe`ê°€ Main Schedulerì—ì„œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.
- side effectë¥¼ ê³µìœ í•©ë‹ˆë‹¤.

```swift
let results = query.rx.text
	.throttle(.milliseconds(300), scheduler: MainScheduler.instance)
	.flatMapLatest { query in
		fetchAutoCompleteItems(query)
	}

results
	.map { "\($0.count)" }
	.bind(to: resultCount.rx.text)
	.disposed(by: self.disposeBag)

results
	.bind(to: resultsTableView.rx.items(cellIdentifier: "Cell")) { _, result, cell in
		cell.textLabel?.text = "\(result)"
	}
	.disposed(by: self.disposeBag)
```

ìœ„ ì˜ˆì‹œëŠ” ì„¸ê°€ì§€ ë¬¸ì œì ë“¤ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.

1. `fetchAutoCompleteItems`ê°€ ì—ëŸ¬ë¥¼ ë°©ì¶œí•  ê²½ìš°, UIì— ë°”ì¸ë”©ë˜ì–´ ìˆë˜ ê²ƒë“¤ì´ ëª¨ë‘ unbindë˜ë©´ì„œ ì´í›„ì˜ ì¿¼ë¦¬ë“¤ì— ë” ì´ìƒ UIê°€ ë³€í™”í•˜ì§€ ì•Šì„ ê²ƒì…ë‹ˆë‹¤.
2. `fetchAutoCompleteItems`ê°€ ë©”ì¸ì“°ë ˆë“œê°€ ì•„ë‹Œ ë°±ê·¸ë¼ìš´ë“œ ì“°ë ˆë“œì— ê²°ê³¼ë¥¼ ë°˜í™˜í•  ê²½ìš°, UIì— ê²°ê³¼ê°’ì„ ë°”ì¸ë”©í•˜ëŠ” ì‘ì—…ì´ ë°±ê·¸ë¼ìš´ë“œ ì“°ë ˆë“œì—ì„œ ì¼ì–´ë‚  ìˆ˜ ìˆê³ , ì´ëŠ” ì˜ˆê¸°ì¹˜ ì•Šì€ í¬ë˜ì‹œë¥¼ ë°œìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
3. ê²°ê³¼ê°’ì´ ë‘ ê°œì˜ UI ì»´í¬ë„ŒíŠ¸(TableView, UILabel)ì— ë°”ì¸ë”©ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— ê°ê°ì´ ë”°ë¡œ HTTP requestë¥¼ ìš”ì²­í•´ ë¶ˆí•„ìš”í•œ ì¤‘ë³µ ìš”ì²­ì´ ë°œìƒí•©ë‹ˆë‹¤.

ì´ë¥¼ í•´ê²°í•œ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

```swift
let results = query.rx.text
	.throttle(.milliseconds(300), scheduler: MainScheduler.instance)
	.flatMapLatest { query in
		fetchAutoCompleteItems(query)
			.observeOn(MainScheduler.instance)
			.catchErrorJustReturn([])
	}
	.share(replay: 1)
```

ì˜ˆì‹œì—ì„œëŠ” ì´ëŸ° ê³¼ì •ì´ ì‰¬ìš¸ ìˆ˜ ìˆìœ¼ë‚˜, ì‹¤ì „ì—ì„œ í”„ë¡œì íŠ¸ê°€ ì»¤ì§ì— ë”°ë¼ ì´ëŸ° ì‚¬ì†Œí•œ ë¬¸ì œì ë“¤ì„ ë°œê²¬í•˜ëŠ” ê²ƒì€ ì–´ë ¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ RxCocoaëŠ” ì´ëŸ° ë¬¸ì œë“¤ì„ í•´ê²°í•œ UI ë ˆì´ì–´ ì „ìš©ì˜ Traitì„ ì œê³µí•˜ëŠ”ë°, ê·¸ê²ƒì´ ë°”ë¡œ Driverì¸ ê²ƒ ì…ë‹ˆë‹¤.

```swift
let results = query.rx.text.asDriver()
	.throttle(.milliseconds(300), scheduler: MainScheduler.instance)
	.flatMapLatest { query in
		fetchAutoCompleteItems(query)
			.asDriver(onErrorJustReturn: [])
	}

results
	.map { "\($0.count)" }
	.drive(resultCount.rx.text)
	.disposed(by: self.disposeBag)

results
	.drive(resultsTableView.rx.items(cellIdentifier: "Cell")) { _, result, cell in
		cell.textLabel?.text = "\(result)"
	}
	.disposed(by: self.disposeBag)
```

ì´ ì„¸ êµ°ë°ë§Œ ì£¼ëª©í•˜ë©´ ë©ë‹ˆë‹¤!

> `query.rx.text.asDriver()`

`asDriver` ë©”ì„œë“œëŠ” `ControlProperty`ë¥¼ `Driver`ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.

`Driver`ëŠ” `ControlProperty`ì˜ ëª¨ë“  í”„ë¡œí¼í‹°ë¥¼ ê°–ê¸° ë•Œë¬¸ì— ë”°ë¡œ ì‹ ê²½ì“¸ ë¶€ë¶„ì€ ì—†ì´ ë³€í™˜ë§Œ í•˜ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> `.asDriver(onErrorJustReturn: [])`

ì´ì „ì— ì‚´í´ë´¤ë˜ ë‹¤ìŒ ì„¸ ê°€ì§€ ì¡°ê±´ë§Œ ë§Œì¡±í•œë‹¤ë©´, ì–´ë–¤ `Observable`ì´ë˜ `Driver`ë¡œ ë³€í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- ì—ëŸ¬ê°€ ë°©ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
- `observe`ê°€ Main Schedulerì—ì„œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.
- side effectë¥¼ ê³µìœ í•©ë‹ˆë‹¤. (`.share(replay:, scope:)`)

```swift
let safeSequence = xs
	.observeOn(MainScheduler.instance)
	.catchErrorJustReturn(onErrorJustReturn)
	.share(replay: 1, scope: .whileConnected)
return Driver(raw: safeSequence)
```

ì •ë¦¬í•´ë³´ë©´ ìœ„ ê³¼ì •ê³¼ `asDriver(onErrorJustReturn: [])`ì€ ë™ì¼í•©ë‹ˆë‹¤.

> `.drive()`

ë§ˆì§€ë§‰ìœ¼ë¡œ `bind(to:)` ëŒ€ì‹  `drive()`ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

`drive()`ë¥¼ ì‚¬ìš©í•¨ìœ¼ë¡œì„œ UIì— ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ë°”ì¸ë”©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## Signal

êµ¬ë…ê³¼ ë™ì‹œì— ê°€ì¥ ë§ˆì§€ë§‰ ì´ë²¤íŠ¸ë¥¼ `replay`í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì  ì™¸ì—ëŠ” Driverì™€ ë™ì¼í•©ë‹ˆë‹¤.

í•˜ì§€ë§Œ sequenceë¥¼ ê³µìœ í•œë‹¤ëŠ” ì ì€ ë³€í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— `share` ë©”ì„œë“œë¥¼ í†µí•´ ì›í•  ë•ŒëŠ” ê°’ì„ ê³µìœ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

# ControlProperty / ControlEvent

## ControlProperty

UI ì»´í¬ë„ŒíŠ¸ì˜ í”„ë¡œí¼í‹°ë¥¼ ë‚´ìš©ìœ¼ë¡œ ê°–ëŠ” `Observable` / `ObservableType` ì…ë‹ˆë‹¤.

- ì‹¤íŒ¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- `share(replay: 1)`
  - Stateful í•©ë‹ˆë‹¤. (êµ¬ë…ê³¼ ë™ì‹œì— ë§ˆì§€ë§‰ ê°’ì„ í•œ ë²ˆ ë°©ì¶œí•©ë‹ˆë‹¤.)
- ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¤ì§€ ì•ŠìŠµë‹ˆë‹¤.
- ë©”ì¸ ì“°ë ˆë“œì—ì„œ ë™ì‘í•©ë‹ˆë‹¤.

```swift
extension Reactive where Base: UISearchBar {
	public var value: ControlProperty<String?> {
		let source: Observable<String?> = Observable.deferred { [weak searchBar = self.base as UISearchBar] () -> Observable<String?> in
			let text = searchBar?.text
			return (searchBar?.rx.delegate.methodInvoked(#selector(UISearchBarDelegate.searchBar(_:textDidChange:))) ?? Observable.empty())
				.map { a in
					return a[1] as? String
				}
				.startWith(text)
		}

		let bindingObserver = Binder(self.base) { (searchBar, text: String?) in
			searchBar.text = text
		}

		return ControlProperty(values: source, valueSink: bindingObserver)
	}
}
```

## ControlEvent

UI ì»´í¬ë„ŒíŠ¸ì˜ ì´ë²¤íŠ¸ë¥¼ ë‚´ìš©ìœ¼ë¡œ ê°–ëŠ” `Observable` / `ObservableType` ì…ë‹ˆë‹¤.

- ì‹¤íŒ¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- êµ¬ë…ì´ ì´ë£¨ì–´ì¡Œì„ ë•Œ ì´ˆê¸°ê°’ì„ ë°©ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- ì—ëŸ¬ë¥¼ ë°©ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- ë©”ì¸ ì“°ë ˆë“œì—ì„œ ë™ì‘í•©ë‹ˆë‹¤.

```swift
extension Reactive where Base: UICollectionView {
	public var itemSelected: ControlEvent<IndexPath> {
		let source = delegate.methodInvoked(#selector(UICollectionViewDelegate.collectionView(_:didSelectItemAt:)))
			.map { a in
				return a[1] as! IndexPath
			}

		return ControlEvent(events: source)
	}
}
```

> References

[RxSwift Traits](https://github.com/ReactiveX/RxSwift/blob/main/Documentation/Traits.md)
